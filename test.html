<html>

<head>
  <title>Ice Cream Picker</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css" />
  <!-- <script src='https://cdn.plot.ly/plotly-2.20.0.min.js'></script> -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
  <script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.canvasjs.com/canvasjs.stock.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script> -->
</head>

</head>

<body>
  <!-- <py-config>
    packages = ["matplotlib", "pandas", "seaborn", "numpy"]
    [[fetch]]
    files = ['bitstampUSD.csv']
  </py-config>



  <py-script>
    import pandas as pd
    import matplotlib.pyplot as plt
    import seaborn as sns
    from pyodide.http import open_url
    import numpy as np



    df = pd.read_csv('bitstampUSD.csv')
    df1= df.dropna()
    df1.reset_index(inplace =True, drop=True)


    def graph_1(data) :
    plt.rcParams["figure.figsize"] = (22,20)
    fig, ax = plt.subplots()
    ax.plot(data["Timestamp"], data["Weighted_Price"])
    ax.set(xlabel='Timestamp', ylabel='Weighted_Price')
    display(fig, target="graph-area_1", append=False)



    def graph_2(data):
    plt.rcParams["figure.figsize"] = (22,20)
    fig, ax = plt.subplots()
    ax.scatter(data["Volume_(BTC)"], data["Volume_(Currency)"], alpha=0.5)
    display(fig, target="graph-area", append=False)



    graph_1(df1)
    graph_2(df1)


  </py-script> -->



  <div id="graph-area"></div>
  <div id="graph-area_1"></div>
  <div id="candleChar" class="chart">
    <div>
      candle chart
    </div>
    <div id="simpleCandleChart1" class="chart"></div>
  </div>
  <div>
    <div>
      bar chart
    </div>
    simple BarChar Open Close
    <div id="simple_BarChar_Open_Close" class="chart">

    </div>
    simple Bar Char High Low
    <div id="simple_Bar_Char_High_Low" class="chart">

    </div>
  </div>
  <div>
    simple line volume
    <div id="simple_line_Volume" class="chart">

    </div>
  </div>
  <div id="linetwocolumn1">

  </div>
  <div id="linetwocolumn2">
</div>
  <script>
    let rowConverter = function (d) {
      let date = []
      let open = []
      let high = []
      let low = []
      let adj_Close = []
      let volume = []
      let close = []

      // Date,Open,High,Low,Close,Adj_Close,Volume  d.length
      for (let i = 0; i < d.length; i++) {
        open.push(Number.parseFloat(d[i].Open))
        high.push(Number.parseFloat(d[i].High))
        low.push(Number.parseFloat(d[i].Low))
        adj_Close.push(Number.parseFloat(d[i].Adj_Close))
        volume.push(Number.parseFloat(d[i].Volume))
        date.push(d[i].Date)
        close.push((Number.parseFloat(d[i].Close)))
      }
      return {
        date,
        open,
        high,
        low,
        adj_Close,
        volume,
        close
      }
    }
    let drawCandleSimple = (idDiv, data, startDate, endDate, typeChart, title) => {
      let trace = {
        x: data.date,
        close: data.close,
        high: data.high,
        low: data.low,
        open: data.open,
        increasing: {
          line: {
            color: 'black'
          }
        },
        decreasing: {
          line: {
            color: 'red'
          }
        },

        //type: 'candlestick',
        type: typeChart,
        xaxis: 'x',
        yaxis: 'y'
      };

      let input = [trace];
      let layout = {
        dragmode: 'zoom',
        showlegend: true,
        xaxis: {
          autorange: true,
          title: title,
          rangeselector: {
            x: 0,
            y: 1.2,
            xanchor: 'left',
            font: {
              size: 8
            },
            buttons: [{
              step: 'month',
              stepmode: 'backward',
              count: 1,
              label: '1 month'
            }, {
              step: 'month',
              stepmode: 'backward',
              count: 6,
              label: '6 months'
            }, {
              step: 'all',
              label: 'All dates'
            }]
          }
        },
        yaxis: {
          autorange: true,
        }
      };
      Plotly.newPlot(idDiv, input, layout);
    }
    let drawCandleStick = (idDiv, data, startDate, endDate, typeChart, title) => {
      let trace = {
        x: data.date,
        close: data.close,
        high: data.high,
        low: data.low,
        open: data.open,
        increasing: {
          line: {
            color: '#17BECF'
          }
        },
        decreasing: {
          line: {
            color: '#7F7F7F'
          }
        },

        line: {
          color: 'rgba(31,119,180,1)'
        },
        //type: 'candlestick',
        type: typeChart,
        xaxis: 'x',
        yaxis: 'y'
      };

      let input = [trace];

      var layout = {
        dragmode: 'zoom',
        margin: {
          r: 10,
          t: 25,
          b: 40,
          l: 60
        },
        showlegend: false,
        xaxis: {
          autorange: true,
          rangeslider: {
            range: [startDate, endDate]
          },
          title: title,
          type: 'date'
        },
        yaxis: {
          autorange: true,
          type: 'linear'
        },

        annotations: [{
          x: startDate,
          y: 0.9,
          xref: 'x',
          yref: 'paper',
          text: 'largest movement',
          font: {
            color: 'magenta'
          },
          showarrow: true,
          xanchor: 'right',
          ax: -20,
          ay: 0
        }],

        shapes: [{
          type: 'rect',
          xref: 'x',
          yref: 'paper',
          x0: startDate,
          y0: 0,
          x1: endDate,
          y1: 1,
          fillcolor: '#d3d3d3',
          opacity: 0.2,
          line: {
            width: 0
          }
        }]
      };
      Plotly.newPlot(idDiv, input, layout);
    }
    let drawBarChart = (row, column1, column2, name1, name2, idDiv) => {
      let trace1 = {
        x: row,
        y: column1,
        name: name1,
        type: "histogram"
      }
      let trace2 = {
        x: row,
        y: column2,
        name: name2,
        type: "histogram",
        marker: {
          color: "rgba(255, 100, 102, 0.7)",
          line: {
            color: "rgba(255, 100, 102, 1)",
            width: 1
          }
        }
      }
      var data = [trace1, trace2];
      var layout = {
        barmode: "stack"
      };
      Plotly.newPlot(idDiv, data, layout);

    }
    let drawLine = (x, y, idDiv, title) => {
      let data = {
        type: "scatter",
        mode: "lines",
        name: 'AAPL Low',
        x,
        y
      }
      input = [data]
      var layout = {
        title: 'Volume',
        xaxis: {
          autorange: true,
          range: ['2015-02-17', '2017-02-16'],
          rangeselector: {
            buttons: [{
                count: 1,
                label: '1m',
                step: 'month',
                stepmode: 'backward'
              },
              {
                count: 6,
                label: '6m',
                step: 'month',
                stepmode: 'backward'
              },
              {
                step: 'all'
              }
            ]
          },
          rangeslider: {
            range: ['2015-02-17', '2017-02-16']
          },
          type: 'date'
        },
        yaxis: {
          autorange: true,
          range: [0, 138.870004167],
          type: 'linear'
        }
      };

      Plotly.newPlot(idDiv, input, layout);

    }
    let addClickAnimation = (idDiv) => {
      let plot = document.getElementById(idDiv)
      plot.on('plotly_click', (data) => {
        let pts = '';
        for (let i = 0; i < data.points.length; i++) {
          annotate_text = 'x = ' + data.points[i].x +
            'y = ' + data.points[i].y.toPrecision(4);

          annotation = {
            text: annotate_text,
            x: data.points[i].x,
            y: parseFloat(data.points[i].y.toPrecision(4))
          }

          annotations = self.layout.annotations || [];
          annotations.push(annotation);
          Plotly.relayout('myDiv', {
            annotations: annotations
          })
        }
      })
    }
    let drawtwoline = (idDiv, x, column1, column2, name1, name2, title) => {
      let max1 = column1.reduce(function (accumulator, element) {
        return (accumulator > element) ? accumulator : element
      });
      let min1 = column1.reduce(function (accumulator, element) {
        return (accumulator < element) ? accumulator : element
      });

      let max2 = column2.reduce(function (accumulator, element) {
        return (accumulator > element) ? accumulator : element
      });
      let min2 = column2.reduce(function (accumulator, element) {
        return (accumulator < element) ? accumulator : element
      });
      let button_layer_2_height = 1
      let trace1 = {
        x,
        y: column1,
        mode: 'lines',
        type: 'scatter',
        name: name1,
        line: {
          color: 'red'
        }
      }
      let trace2 = {
        x,
        y: column2,
        mode: 'lines',
        type: 'scatter',
        name: name1,
        line: {
          color: '#7F7F7F'
        }
      }
      let column1_annotations = [{
          text: 'high ' + max1,
          x: x[column1.indexOf(max1)],
          y: max1,
          yref: 'y',
          xref: 'x',
          ay: 90,
          ax: 0
        },
        {
          text: 'low ' + min1,
          x: x[column1.indexOf(min1)],
          y: min1,
          yref: 'y',
          xref: 'x',
          ay: 50,
          ax: 0
        }
      ]
      let column2_annotations = [{
          text: 'High' + max2,
          x: x[column2.indexOf(max2)],
          y: max2,
          yref: 'y',
          xref: 'x',
          ay: -50,
          ax: 0
        },
        {
          text: 'Low ' + min2,
          x: x[column2.indexOf(min2)],
          y: min1,
          yref: 'y',
          xref: 'x',
          ay: -50,
          ax: 0
        }
      ]
      var updatemenus = [{
          buttons: [{
              args: [{
                  'visible': [true, false, false, false]
                },
                {
                  'title': name1,
                  'annotations': column1_annotations
                }
              ],
              label: name1,
              method: 'update'
            },
            {
              args: [{
                  'visible': [false, true, false, false, ]
                },
                {
                  'title': name2,
                  'annotations': column2_annotations
                }
              ],
              label: name2,
              method: 'update'
            },
            {
              args: [{
                  'visible': [true, true, false, false, ]
                },
                {
                  'title': name1 + name2,
                  'annotations': [...column1_annotations, ...column2_annotations]
                }
              ],
              label: 'Both',
              method: 'update'
            }

          ],
          direction: 'left',
          pad: {
            'r': 10,
            't': 10
          },
          showactive: true,
          type: 'buttons',
          x: 0.1,
          xanchor: 'left',
          y: button_layer_2_height,
          yanchor: 'top'
        },

      ]
      let data = [trace1, trace2]
      let layout = {
        title,
        updatemenus: updatemenus,
        showlegend: false,
        xaxis: {
          autorange: true,
          range: ['2015-02-17', '2017-02-16'],
          rangeselector: {
            buttons: [{
                count: 1,
                label: '1m',
                step: 'month',
                stepmode: 'backward'
              },
              {
                count: 6,
                label: '6m',
                step: 'month',
                stepmode: 'backward'
              },
              {
                step: 'all'
              }
            ]
          },
          rangeslider: {
            range: ['2015-02-17', '2017-02-16']
          },
          type: 'date'
        },
        yaxis: {
          autorange: true,
          range: [86.8700008333, 138.870004167],
          type: 'linear'
        }
      };
      Plotly.newPlot(idDiv, data, layout);

    }
  </script>
  <script>
    d3.csv("https://raw.githubusercontent.com/Chaudeptrai123456/DataViz/master/BTC-USD.csv", function (raw_data) {
      let data = rowConverter(raw_data)
      drawCandleSimple("simpleCandleChart1", data, "2008-08-08", "2016-07-01", 'candlestick', 'BTC-USD')
      drawBarChart(data.date, data.close, data.open, 'close', 'open', 'simple_BarChar_Open_Close')
      drawBarChart(data.date, data.high, data.low, 'high', 'close', 'simple_Bar_Char_High_Low')
      drawLine(data.date, data.volume, 'simple_line_Volume', 'Volume')
      drawtwoline('linetwocolumn1', data.date, data.close, data.open, "Close", "Open", "CLose - Open")
      drawtwoline('linetwocolumn2', data.date, data.high, data.low, "High", "Low", "High - Low")
      
      // addFeater("feater",data)
    })
  </script>


</body>

</html>